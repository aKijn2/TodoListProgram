<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="TaskFlow.MainPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:models="clr-namespace:TaskFlow.Models"
    xmlns:viewmodels="clr-namespace:TaskFlow.ViewModels"
    xmlns:views="clr-namespace:TaskFlow.Views"
    Title="{Binding Title}"
    x:DataType="viewmodels:TaskListViewModel"
    BackgroundColor="{AppThemeBinding Light={StaticResource White},
                                      Dark={StaticResource PageBackgroundColor}}"
    Shell.NavBarIsVisible="False">

    <Grid BackgroundColor="{AppThemeBinding Light={StaticResource White},
                                            Dark={StaticResource PageBackgroundColor}}">

        <!--  Main Content Area  -->
        <Grid RowDefinitions="Auto,Auto,*">

            <!--  HEADER  -->
            <views:MainHeaderView Grid.Row="0" Margin="0" />

            <!--  SEARCH BAR  -->
            <Border Grid.Row="1"
                    Margin="20,10"
                    Padding="0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource White},
                                                      Dark={StaticResource CardBackgroundColor}}"
                    HeightRequest="46"
                    Stroke="{AppThemeBinding Light={StaticResource Gray200},
                                             Dark={StaticResource BorderColor}}"
                    StrokeShape="RoundRectangle 12"
                    StrokeThickness="1">
                <Grid Padding="15,0" ColumnDefinitions="Auto,*">
                    <!--  Search Icon  -->
                    <Path Grid.Column="0"
                          Aspect="Uniform"
                          Data="{StaticResource IconSearch}"
                          Fill="{AppThemeBinding Light={StaticResource Black},
                                                 Dark={StaticResource PrimaryTextColor}}"
                          HeightRequest="16"
                          VerticalOptions="Center"
                          WidthRequest="16" />

                    <Entry Grid.Column="1"
                           FontFamily="Inter"
                           FontSize="14"
                           Margin="10,0,0,0"
                           Placeholder="Search tasks..."
                           PlaceholderColor="{AppThemeBinding Light={StaticResource Gray600},
                                                              Dark={StaticResource SecondaryTextColor}}"
                           Text="{Binding SearchText}"
                           TextColor="{AppThemeBinding Light={StaticResource Black},
                                                       Dark={StaticResource PrimaryTextColor}}"
                           VerticalOptions="Center" />
                </Grid>
            </Border>

            <!--  Task List Content  -->
            <Grid Grid.Row="2">
                <!--  Empty State  -->
                <views:EmptyStateView />

                <!--  Task Lists  -->
                <ScrollView IsVisible="{Binding HasTasks}" VerticalScrollBarVisibility="Never">
                    <StackLayout Padding="20,0,20,100" Spacing="24">

                        <!--  TODAY SECTION  -->
                        <VerticalStackLayout IsVisible="{Binding TodayTasks.Count, Converter={StaticResource IntToBoolConverter}}" Spacing="12">
                            <Grid ColumnDefinitions="*,Auto">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleTodayCommand}" />
                                </Grid.GestureRecognizers>
                                <Label FontAttributes="Bold"
                                       FontFamily="Inter"
                                       FontSize="16"
                                       Text="Today"
                                       TextColor="{AppThemeBinding Light={StaticResource Black},
                                                                   Dark={StaticResource PrimaryTextColor}}"
                                       VerticalOptions="Center" />
                                <Label Grid.Column="1"
                                       FontSize="12"
                                       Text="▼"
                                       TextColor="{AppThemeBinding Light={StaticResource Black},
                                                                   Dark={StaticResource PrimaryTextColor}}"
                                       VerticalOptions="Center">
                                    <Label.Triggers>
                                        <DataTrigger Binding="{Binding IsTodayExpanded}"
                                                     TargetType="Label"
                                                     Value="False">
                                            <Setter Property="Rotation" Value="-90" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </Grid>

                            <CollectionView IsVisible="{Binding IsTodayExpanded}"
                                            ItemsSource="{Binding TodayTasks}"
                                            SelectionMode="None">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:TaskItem">
                                        <views:TaskItemView />
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>

                        <!--  COMING UP SECTION  -->
                        <VerticalStackLayout IsVisible="{Binding UpcomingTasks.Count, Converter={StaticResource IntToBoolConverter}}" Spacing="12">
                            <Grid ColumnDefinitions="*,Auto">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding ToggleUpcomingCommand}" />
                                </Grid.GestureRecognizers>
                                <Label FontAttributes="Bold"
                                       FontFamily="Inter"
                                       FontSize="16"
                                       Text="Coming Up"
                                       TextColor="{AppThemeBinding Light={StaticResource Black},
                                                                   Dark={StaticResource PrimaryTextColor}}"
                                       VerticalOptions="Center" />
                                <Label Grid.Column="1"
                                       FontSize="12"
                                       Text="▼"
                                       TextColor="{AppThemeBinding Light={StaticResource Black},
                                                                   Dark={StaticResource PrimaryTextColor}}"
                                       VerticalOptions="Center">
                                    <Label.Triggers>
                                        <DataTrigger Binding="{Binding IsUpcomingExpanded}"
                                                     TargetType="Label"
                                                     Value="False">
                                            <Setter Property="Rotation" Value="-90" />
                                        </DataTrigger>
                                    </Label.Triggers>
                                </Label>
                            </Grid>

                            <CollectionView IsVisible="{Binding IsUpcomingExpanded}"
                                            ItemsSource="{Binding UpcomingTasks}"
                                            SelectionMode="None">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="models:TaskItem">
                                        <views:TaskItemView />
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </VerticalStackLayout>
                    </StackLayout>
                </ScrollView>
            </Grid>
        </Grid>

        <!--  BOTTOM TAB BAR  -->
        <views:FilterTabsView VerticalOptions="End" />

        <!--  SETTINGS OVERLAY  -->
        <views:SettingsOverlayView />

        <!-- Custom Delete Confirmation Overlay -->
        <views:DeleteConfirmationView Grid.RowSpan="2"
                                      Grid.ColumnSpan="2"
                                      ZIndex="999" />
    </Grid>
</ContentPage>